#!/usr/bin/env bash

set -e

cwd="$(cd "$(dirname "$0")" && pwd)"

cd "$1"

# shellcheck source=config
. "$cwd"/config

# shellcheck disable=SC2154
CHART_DIR=$(echo "$config" | jq -r ".params.chart")
CHART_VERSION=$(echo "$config" | jq -r ".params.version_file" | xargs cat)
CHART_APP_VERSION=$(echo "$config" | jq -r ".params.app_version_file" | xargs cat)

CHART_YAML_FILE=Chart.yaml
CHART_YAML=${CHART_DIR}/${CHART_YAML_FILE}

if [ ! -f ${CHART_YAML} ]
then
  log "ðŸ˜µ $RED$CHART_YAML_FILE$NC not found in $CHART_DIR"
  exit 1
fi

function readChartName {
  helm show chart ${CHART_DIR} | grep "^name: " | cut -d' ' -f2
}

EFFECTIVE_CHART_NAME=$(readChartName)
if [[ "$CHART_NAME" != "$EFFECTIVE_CHART_NAME" ]]
then
  log "âš ï¸ Chart name $RED$EFFECTIVE_CHART_NAME$NC in $CHART_YAML_FILE does not match config. Overriding with $GREEN$CHART_NAME$NC..."
  sed -i '/^name:/d' ${CHART_YAML}
  echo -e "\nname: $CHART_NAME" >> ${CHART_YAML}
  if [[ "$CHART_NAME" != "$(readChartName)" ]]
  then
    log "ðŸ˜µðŸ˜µðŸ˜µ Failed setting chart name $RED$CHART_NAME$NC in $RED$$CHART_YAML"
    exit 1
  fi
else
  log "ðŸ•µï¸ Chart name: $GREEN$CHART_NAME"
fi

if ! aws s3api head-bucket --bucket "$S3_BUCKET_NAME"
then
  log $RED"Bucket $S3_BUCKET_NAME doesn't exist or the user doesn't have sufficient permissions."
  exit 1
else
  log "âœ… Bucket $GREEN$S3_BUCKET_NAME$NC is accessible "
fi
log "ðŸ•µï¸ Bucket region: $GREEN$AWS_DEFAULT_REGION"

if ! aws s3 ls ${REPO_ADDRESS}/index.yaml >/dev/null 
then
  log "Initializing the repository in S3"
  helm s3 init ${REPO_ADDRESS} 1>&2
  log "âœ… Repository $GREEN$REPO_ADDRESS$NC initialized in S3"
else
  log "âœ… Repository index found in S3"
fi

log "Packaging the chart"
CHART_ARCHIVE="./$CHART_NAME-$CHART_VERSION.tgz"
helm package $CHART_DIR --version=$CHART_VERSION --app-version=$CHART_APP_VERSION 1>&2

log "Pushing the chart to S3..."
helm s3 push $CHART_ARCHIVE s3 1>&2

log "ðŸŽ‰ Chart $CHART_VERSION pushed."

echo "{\"version\": {\"ref\": \"$CHART_VERSION\"}}"
